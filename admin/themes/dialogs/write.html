<div id="MarkDialog" class="maskview" style="display:none;">
	<div class="tools">
		<div class="container write clearfix">
			<div class="pull-left">
				文件名：<code id="rename"><span id="path"></span>/<span id="filename" title="点击可修改" contenteditable="true"></span>.md</code>
				<span id="info" style="color:#999;font-size:12px;"></span>
			</div>
			<div class="pull-right">
				<span class="btn btn-xs" id="save" title="快捷键:ctl+s"><i class="glyphicon glyphicon-hdd"></i> 保存</span>
				<span class="btn btn-xs" id="close"><i class="glyphicon glyphicon-remove"></i> 关闭</span>
			</div>
		</div>
	</div>
	<div class="container write" id="test-textarea" style="margin-top:60px;">
		<div id="test-editormd"><textarea style="display:none;" name="content"></textarea></div>
	</div>
	<script>
	$('#MarkDialog').slideDown();
	var testEditor = null;
	var isCreate = true;
	var presavedata = '';
	
	function createEditor(){
		testEditor = editormd("test-editormd", {
			width:960,
			height:920,
			syncScrolling:"single",
			path:"static/editor/lib/",
			imageUpload:true,
			imageFormats:["jpg", "jpeg", "gif", "png", "bmp"],
			imageUploadURL:"./upload/upload.php",
			emoji:true,
			tex:true,
			flowChart:true,
			watch:false
		});
	}
	
	$('#save').click(save);
	var timer = setInterval(save,10000);

	$('#close').click(function(){
		$('#MarkDialog').slideUp('fast',function(){
			if(isCreate){
				document.querySelector('#firstMenu').querySelector('.active').click();
			}else{
				document.querySelector('#midList').querySelector('.active').click();
			}
			console.log(isCreate);
			clearInterval(timer);
			closeDialog();
		});
	});

	
	function save(){
		var data = testEditor.getMarkdown();
		if(data == '' || data == presavedata) return;
		var file = getFilename();
		$.ajax({
			url:"./ajax.php?mod=addfile&t="+file.path+"/"+file.filename+".md",
			method:"POST",
			data:{data:data},
			dataType:"JSON",
			success:function(rsp){
				presavedata = data;
				var date = new Date();
				$('#info').html('已保存于'+date.getHours()+"点"+date.getMinutes()+"分"+date.getSeconds()+'秒');
			}
		});
	}

	$('#filename').click(function(){
		$('#filename').css('background','#FFF');
		$('#filename').one('blur',function(){
			$('#filename').css('background','none');
		});
	});

	getFilename();
	
	function getFilename(){
		var filename = $('#filename').html();
		var path = $('#path').html();
		if(filename && path){
			return {path:path,filename:filename};
		}
		var path = vue.queryParam;
		if(path.indexOf('.md') >= 0){
			isCreate = false;
			
			$.ajax({
				url:"./ajax.php?mod=mdcontent&t="+path,
				method:"GET",
				dataType:"JSON",
				success:function(rsp){
					if(rsp.code != 200){
						return alert(rsp.data);
					}
					presavedata = rsp.data
					$('#test-editormd textarea:first').val(presavedata);
					createEditor();
				}
			});
			var arr = path.split('/');
			filename = arr[arr.length-1].replace('.md','');
			path = arr.slice(0,arr.length-1).join('/');
		}else{
			isCreate = true;
			filename = 'autoname'+parseInt(Date.parse(new Date()) / 1000);
			createEditor();
		}
		console.log(isCreate);
		$('#filename').html(filename);
		$('#path').html(path);
	}
	
	//保存快捷键 ctrl+s
	$(document).keydown(function(e){
		if( e.ctrlKey  == true && e.keyCode == 83 ){
			save();
			return false;
		}
	});
	</script>
</div>

